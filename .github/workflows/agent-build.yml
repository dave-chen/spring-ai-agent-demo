name: Agent Build

on:
  repository_dispatch:
    types: [agent-build, agent-feedback]

jobs:
  agent-build:
    runs-on: self-hosted
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
    env:
      REPO: ${{ github.repository }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip3 install requests boto3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}
        continue-on-error: true
        id: oidc-creds

      - name: Use local AWS credentials if OIDC fails
        if: steps.oidc-creds.outcome == 'failure'
        run: |
          echo "ℹ️  OIDC auth failed (expected for self-hosted runners)"
          echo "AWS_REGION=${{ secrets.AWS_REGION }}" >> $GITHUB_ENV
          # Credentials from ~/.aws/credentials will be used automatically
          echo "Using local ~/.aws/credentials for AWS access"

      - name: Verify tools installed
        run: |
          which java && java -version
          which python3 && python3 --version
          which aws && aws --version
          which gh && gh --version
          which jq && jq --version

      - name: Acquire Lock
        env:
          ISSUE_NUMBER: ${{ github.event.client_payload.issue_number }}
          LOCK_KEY: ${{ github.event.client_payload.lock_key }}
        run: |
          python3 scripts/lock.py acquire --lock-key "${LOCK_KEY}" --ttl-minutes 30

      - name: Run agent build
        env:
          ISSUE_NUMBER: ${{ github.event.client_payload.issue_number }}
          PR_NUMBER: ${{ github.event.client_payload.pr_number }}
          FEEDBACK: ${{ github.event.client_payload.feedback }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          AGENTCORE_ROLE_ARN: ${{ secrets.AGENTCORE_ROLE_ARN }}
          AGENTCORE_RUNTIME_ID: ${{ secrets.AGENTCORE_RUNTIME_ID }}
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
          CLAUDE_MODEL: ${{ secrets.CLAUDE_MODEL || 'claude-sonnet-4-5-20250929' }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          # Only set USE_BEDROCK if AGENTCORE_RUNTIME_ID is actually present
          USE_BEDROCK: ${{ secrets.AGENTCORE_RUNTIME_ID != '' && 'true' || '' }}
        run: |
          # Authenticate gh CLI for PR creation
          echo "Authenticating gh CLI"
          echo "${GITHUB_TOKEN}" | gh auth login --with-token || true
          gh auth status || true
          bash scripts/agent-build.sh ${ISSUE_NUMBER}

      - name: Release lock
        env:
          LOCK_KEY: ${{ github.event.client_payload.lock_key }}
        run: |
          python3 scripts/lock.py release --lock-key "${LOCK_KEY}"
